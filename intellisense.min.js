/* ==========================================================================
   SUPA HUB LIBRARY & PARSER MODULE
   Contains: Sidebar Library, Inline Script Editor, Monaco Config, Parser/Compiler
   ========================================================================== */

(function(global) {
    'use strict';

    // --- DATA: ACTIONS & PARAMS ---
    const MODD_ACTIONS = [
        "if", "else", "then", "killThisGameInstance", "return", "sendPostRequest", "sendSecurePostRequest", "break", "forAllElementsInAnObject", "forAllEntitiesInAnEntityGroup", "forAllItemTypesInAnItemTypeGroup", "forAllItemsInAItemGroup", "forAllPlayersInAPlayerGroup", "forAllProjectilesInAProjectileGroup", "forAllPropsInAPropGroup", "forAllRegionsInARegionGroup", "forAllUnitTypesInAUnitTypeGroup", "forAllUnitsInAUnitGroup", "forInLoop", "forLoop", "repeatXTimes", "repeatXTimesWithDelay", "skipIteration", "while", "runEntityScript", "runEntityScriptOnClient", "runScript", "runScriptOnClient", "addNewBotPlayer", "changeAIUnitPathfindingMethod", "commandAIUnitToAttackUnit", "commandAIUnitToGoIdle", "commandAIUnitToMoveToPosition", "disableAI", "enableAI", "setUnitLetGoDistance", "setUnitMaxAttackRange", "setUnitMaxTravelDistance", "addWordsToChatFilter", "makePlayerSendChatMessage", "sendModdCoinsToPlayer", "askPlayerToJoinCompetition", "endCompetitionAndDistributeRewards", "startAcceptingPlayersForCompetition", "setAmbientLightColor", "setAmbientLightIntensity", "setDirectionalLightColor", "setDirectionalLightIntensity", "setDirectionalLightPosition", "setFogColor", "setFogDensity", "setFogEnabled", "setFogFar", "setFogNear", "setGravity", "setSkyboxOpacity", "changeLayerOpacity", "editMapTile", "editMapTiles", "loadMapFromString", "promptLoginModalForPlayer", "saveCurrentMapState", "sendDataFromClientToServer", "sendDataFromServerToClient", "addQuestToPlayer", "completeQuest", "removeQuestForPlayer", "setQuestProgress", "toggleOutlineOnEntity", "renderLineBetweenPositions", "openWalletConnectInterfaceForPlayer", "fetchTreasuryTokenBalance", "sendPlayerGroupToDifferentMap", "sendPlayerToDifferentMap", "sendPlayerToGame", "sendPlayerToLastSpawningMap", "playVideoAdForEveryone", "playVideoAdForPlayer", "makeCameraLookAtPosition", "makePlayerCameraStopTrackingUnit", "makePlayerCameraTrackUnit", "setCameraDeadzone", "setPlayerCameraPitch", "setPlayerCameraYaw", "setPlayerCameraZoom", "unlockCameraPointer", "closeDialogueForPlayer", "openDialogueForPlayer", "activateEntity", "applyForceOnEntityXY", "applyForceOnEntityXYLossTolerant", "applyForceOnEntityXYRelative", "applyForceOnEntityAtAngle", "applyForceOnEntityAtAngleLossTolerant", "applyImpulseOnEntityXY", "applyImpulseOnEntityAtAngle", "applyImpulseOnEntityInDirection", "applyTorqueOnEntity", "applyTorqueOnEntityToFacePosition", "changeModelSprite", "changeScaleOfEntityBody", "changeScaleOfEntitySpriteModel", "changeColorOfEntity", "createEntityAtPosition", "createEntityAtPosition2d", "createEntityAtPositionWithDimension", "deactivateEntity", "destroyEntity", "flipEntitySprite", "hideEntity", "moveEntity", "playEntityAnimation", "rotateEntity3d", "rotateEntityToFacePositionInstantly", "rotateEntityToRadians", "setEntityAttributeMaxValue", "setEntityAttributeMinValue", "setEntityAttributeRegenerationRate", "setEntityAttributeValue", "setEntityLifeSpan", "setEntityOpacity", "setEntityState", "setEntityVelocityAtAngle", "setEntityVelocityInDirection", "setEntityZOffset", "setVelocityOfEntityXY", "showEntity", "stopPlayingAllEntityAnimations", "stopPlayingEntityAnimation", "teleportEntity", "changeDescriptionOfItem", "changeItemInventorySlotColor", "createItemAtPosition", "createItemWithMaxQuantityAtPosition", "disableItemRotationFacingMouseCursor", "dropItemAtPosition", "enableItemRotationFacingMouseCursor", "giveNewItemToUnit", "giveNewItemToUnitWithQuantity", "playItemTween", "setFireRateOfItem", "setItemInventoryImage", "setItemName", "setLastAttackingItem", "startUsingItem", "stopUsingItem", "updateItemQuantity", "useItemOnce", "playMusicForEveryone", "playMusicForPlayer", "playMusicForPlayerAtTime", "playMusicForPlayerRepeatedly", "stopMusicForEveryone", "stopMusicForPlayer", "decreaseVariableByNumber", "increaseVariableByNumber", "addBooleanElementIntoObject", "addNumberElementIntoObject", "addObjectElementIntoObject", "addStringElementIntoObject", "removeElementFromObject", "startEmittingParticles", "stopEmittingParticles", "applyLoadedUserDataToPlayerAndUnit", "assignPlayerToPlayerType", "hideGameSuggestions", "kickPlayer", "loadPlayerDataFromString", "makePlayerInitiateItemTradeWithPlayer", "makePlayerSelectUnit", "mutePlayerFromChat", "openWebsiteForPlayer", "savePlayerData", "setPlayerAttributeMaxValue", "setPlayerAttributeMinValue", "setPlayerAttributeRegenerationRate", "setPlayerAttributeValue", "setPlayerName", "showGameSuggestions", "startAcceptingPlayers", "stopAcceptingPlayers", "unmutePlayerFromChat", "addPlayerToPlayerGroup", "removePlayerFromPlayerGroup", "createProjectileAtPosition", "setSourceItemOfProjectile", "setSourceUnitOfProjectile", "createPropAtPosition", "changeRegionColor", "transformRegion", "changeSensorRadius", "closeShopForPlayer", "openShopForPlayer", "openSkinShopForPlayer", "openSkinSubmissionPageForPlayer", "triggerPurchaseOfItemFromShopForPlayer", "playSoundAtPosition", "playSoundForPlayer", "stopSoundForPlayer", "setTimeout", "addClassToUIElement", "appendRealtimeCSSForPlayer", "closeBackpackForPlayer", "comment", "createDynamicFloatingText", "createFloatingText", "createFloatingTextOnUnit", "hideUIElementForPlayer", "hideOverlayTextForEveryone", "hideOverlayTextForPlayer", "openBackpackForPlayer", "removeClassFromUIElement", "sendChatMessage", "sendChatMessageToPlayer", "setUIElementProperty", "setInnerHTMLOfUIElementWithID", "setUnitNameLabel", "setUnitNameLabelColorForPlayer", "showUIElementForPlayer", "showCustomModalToPlayer", "showDismissibleInputModalToPlayer", "showInputModalToPlayer", "showInviteFriendsModalToPlayer", "showMenu", "showMenuAndSelectBestServer", "showMenuAndSelectCurrentlyConnectedServer", "showOverlayTextForEveryone", "showOverlayTextForPlayer", "updateOverlayTextForXMilliseconds", "updateOverlayTextForEveryone", "updateOverlayTextForPlayer", "updateRealtimeCSSForPlayer", "addAttributeBuffToUnit", "changeUnitType", "createUnitAtPosition", "dropAllItems", "dropItemInInventoryAtSlot", "hideMinimapUnit", "hideUnitNameLabelFromHostilePlayers", "hideUnitNameLabelFromPlayer", "hideUnitUI", "loadUnitDataFromString", "makeUnitCastAbilityOnce", "makeUnitInvisibleToFriendlyPlayers", "makeUnitInvisibleToHostilePlayers", "makeUnitInvisibleToNeutralPlayers", "makeUnitPickUpItem", "makeUnitSelectItemAtSlot", "makeUnitVisibleToFriendlyPlayers", "makeUnitVisibleToHostilePlayers", "makeUnitVisibleToNeutralPlayers", "moveUnitDown", "moveUnitLeft", "moveUnitRight", "moveUnitUp", "removeAllAttributeBuffsFromUnit", "saveUnitData", "setLastAttackedUnit", "setLastAttackingUnit", "setOwnerOfUnit", "showUnitInMinimap", "showUnitNameLabelToHostilePlayers", "showUnitNameLabelToPlayer", "showUnitUI", "startCastingAbility", "stopCastingAbility", "stopMovingUnit", "stopUnitX", "stopUnitY", "addUnitToUnitGroup", "removeUnitFromUnitGroup", "sendUtilityTokensToPlayer"
    ];
    const MODD_PARAMS = [
        "globalVariable", "playerVariable", "lastTriggeringAttribute", "attributeTypeOfAttribute", "entityExistsInGame", "isCircleOccupied", "isEntityServerCulled", "isPlayerLocalClient", "isPlayerAiAgent", "isPlayerOnMobile", "isPositionInWall", "isQuestActive", "isQuestCompleted", "isRectangleOccupied", "isUnitMoving", "itemFiresProjectiles", "notValue", "objectContainsElement", "playerHasAdblockEnabled", "playerIsControlledByBot", "playerIsControlledByHumanBot", "playerIsControlledByComputer", "playerIsHostileAgainstAnotherPlayer", "playerIsLoggedIn", "playerIsNeutralToAnotherPlayer", "playerIsCreator", "playersIsFriendlyToAnotherPlayer", "regionOverlapsWithRegion", "roleNameExistsForPlayer", "stringContainsString", "stringEndsWithString", "stringIsNumber", "stringStartsWithString", "unitHasAIEnabled", "unitIsCarryingItemOfItemType", "getEntityFromId", "lastCreatedProp", "lastTouchedProp", "lastTriggeringEntity", "lastTriggeringProp", "selectedEntity", "thisEntity", "allEntitiesInGame", "entitiesBetweenTwoPositions", "entitiesCollidingWithLastTriggeringRaycast", "entitiesInRegion", "entitiesInRegionWidthHeightInFrontOfEntityAtDistance", "itemCurrentlyHeldByUnit", "itemInInventorySlot", "lastAttackingItem", "lastCreatedItem", "lastTouchedItem", "lastTriggeringItem", "lastUsedItem", "selectedItem", "sourceItemOfProjectile", "allItemsDroppedOnGround", "allItemsInGame", "allItemsOfItemType", "allItemsOwnedByUnit", "getItemTypeFromStringId", "itemTypeOfItem", "randomItemTypeFromItemTypeGroup", "selectedItemType", "allItemTypesInGame", "absoluteValueOfNumber", "angleBetweenPlayerMouseCursorAndCenterOfWindow", "angleBetweenPositions", "arctanOfAngle", "arrayLength", "cameraHeightLocal", "cameraWidthLocal", "convertDegreesIntoRadians", "convertRadiansToDegrees", "cosOfAngle", "currentTime", "defaultAttributeValueOfUnitType", "defaultQuantityOfItemType", "distanceBetweenPositions", "entityAttributeMax", "entityAttributeMin", "entityAttributePreviousValue", "entityAttributeRegenerationRate", "entityAttributeValue", "entityBodyHeight", "entityBodyWidth", "entityOpacity", "entityVelocityX", "entityVelocityY", "entityVelocityZ", "entityFacingAngle", "exponentValue", "fireRateOfItemType", "getCameraPitch", "getCameraYaw", "getQuestProgress", "heightOfRegion", "itemQuantity", "itemQuantityMax", "lastFetchedTreasuryTokenBalance", "lastPlayerCompetitionParticipationCost", "lastPlayerCompetitionRewardAmount", "lengthOfString", "lerp", "logBase10", "mapTileIDAtPosition", "mapHeight", "mapWidth", "mathCeiling", "mathFloor", "mathRound", "mathSign", "maxQuantityOfItemType", "maximumValueBetweenTwoNumbers", "minimumValueBetweenTwoNumbers", "numberAtFixedDecimalPlaces", "numberConvertedFromString", "numberOfAllUnitsInGame", "numberOfElementsInObject", "numberOfHumanPlayers", "numberOfInvitesByPlayer", "numberOfItemsPresent", "numberOfPlayersOfPlayerType", "numberOfUnitsOfUnitType", "playerAttributeMax", "playerAttributeMin", "playerAttributeRegenerationRate", "playerAttributeValue", "playerHighScore", "playerLastPlayedTime", "quantityOfItemTypeInItemTypeGroup", "quantityOfUnitTypeInUnitTypeGroup", "randomNumber", "rotateSpeedOfUnitType", "selectedInventorySlot", "serverAge", "serverStartTime", "sinOfAngle", "squareRoot", "tanOfAngle", "unitSensorRadius", "unitTypeDefaultHeight", "unitTypeDefaultWidth", "unitFacingAngle", "widthOfRegion", "xCoordinateOfPosition", "xCoordinateOfRegion", "yCoordinateOfPosition", "yCoordinateOfRegion", "zCoordinateOfPosition", "elementFromObject", "emptyObject", "getAllActiveQuestObjects", "getAllActiveQuestObjectsInThisMap", "getQuestObject", "lastDataReceivedFromClientForPlayer", "lastDataReceivedFromServer", "lastRequestedCompetitionDetails", "lastRequestedCompetitionParticipants", "lastTokenSwapInfoForPlayer", "objectConvertedFromString", "purchasedItemDetails", "selectedElement", "thisRequestData", "itemParticle", "computerPlayer", "getPlayerByUserId", "getPlayerFromId", "lastPlayerSelectingDialogueOption", "lastTriggeringPlayer", "localPlayer", "ownerOfUnit", "selectedPlayer", "allPlayers", "allPlayersOfPlayerType", "botPlayers", "competingPlayers", "computerPlayers", "humanPlayers", "playerTypeOfPlayer", "cameraPositionLocal", "centerOfRegion", "entityPosition", "lerpPosition", "mobileSecondaryTouchPositionLocal", "mouseCursorPosition", "mouseCursorPositionInWorldSpace", "positionInFrontOfPosition", "randomPositionInRegion", "xyCoordinate", "lastCreatedProjectile", "lastOverlappingProjectile", "lastTouchedProjectile", "lastTriggeringProjectile", "selectedProjectile", "allProjectilesInGame", "allProjectilesOfProjectileType", "getProjectileTypeFromStringId", "projectileTypeOfItemType", "projectileTypeOfProjectile", "selectedProp", "allPropsInGame", "allPropsOfPropType", "dynamicRegion3d", "dynamicRegion", "entireMapRegion", "entityBounds", "lastTriggeringRegion", "regionWithMatchingName", "selectedRegion", "allRegionsInGame", "lastTriggeringSensor", "unitSensor", "currentStateOfEntity", "UIElementPropertyLocal", "animationsPlayingByEntity", "arrayElement", "concatenate", "entityCategory", "entityId", "gameId", "getPlayerAgentId", "insertElementIntoArray", "inventoryURLOfItemType", "itemDescription", "lastChatMessageSentByPlayer", "lastClickedUIElementIDByPlayer", "lastPlayerCustomInput", "lastReceivedPOSTResponse", "lastTriggeringQuestId", "lastUpdatedVariableName", "mapJson", "nameOfEntity", "nameOfItemType", "nameOfPlayer", "nameOfRegion", "nameOfUnitType", "numberConvertedToLargeNumberNotation", "playerCurrentDialogue", "playerData", "playerId", "playerUsername", "playerWalletAddress", "realtimeCSSOfPlayer", "removeArrayElement", "replaceValueInString", "selectedElementKey", "stringConvertedFromNumber", "stringConvertedFromObject", "substringOf", "timeString", "toLowerCase", "toUpperCase", "unitData", "unitTypeDefaultModelSprite", "updateArrayElement", "globalVariableByName", "entityTint", "entityVariable", "undefinedValue", "lastAbilityCastingUnit", "lastAttackedUnit", "lastAttackingUnit", "lastCreatedUnit", "lastPurchasedUnit", "lastTouchedUnit", "lastTouchingUnit", "lastTriggeringUnit", "ownerOfItem", "ownerUnitOfSensor", "playerCurrentlySelectedUnit", "selectedUnit", "sourceUnitOfProjectile", "targetUnitOfUnit", "allUnitsInRegion", "allUnitsInGame", "allUnitsOfUnitType", "allUnitsOwnedByPlayer", "getUnitTypeFromStringID", "randomUnitTypeFromUnitTypeGroup", "selectedUnitType", "unitTypeOfLastPurchasedUnit", "unitTypeOfUnit", "allUnitTypesInGame", "centerOfRegion3d", "directionVectorBetweenPositions", "entityPosition3d", "entityRotation3d", "entityLastRaycastCollidingPosition", "entityLastRaycastStartPosition", "lerpPosition3d", "positionInFrontOfPosition3d", "randomPositionInRegion3d", "unitAIOriginalPosition", "vectorBetweenPositions", "vector3"
    ];

    const DEFAULT_LIB = [
        {
            id: 'root_folder',
            name: 'Default Scripts',
            type: 'folder',
            isOpen: true,
            children: [
                { id: 'def_1', name: 'Basic Template', type: 'script', icon: 'üìÑ', json: null },
                {
                    id: 'def_2', name: 'Full Commands System', type: 'script', icon: 'üìÑ', json: {
                        "triggers": [],
                        "conditions": [{ "operator": "==", "operandType": "boolean" }, true, true],
                        "actions": [{ "type": "comment", "comment": "logic", "runMode": 0 }],
                        "name": "Full Chat Command System",
                        "parent": null,
                        "key": "generated_later"
                    }
                }
            ]
        },
        { id: 'user_folder', name: 'My Saved Scripts', type: 'folder', isOpen: true, children: [] }
    ];

    let LIBRARY_DATA = [];

    // --- UTILS ---
    function generateScriptKey() {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let res = '';
        for (let i = 0; i < 16; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
        return res;
    }

    function getDefaultScript(name) {
        return {
            "triggers": [],
            "conditions": [{ "operator": "==", "operandType": "boolean" }, true, true],
            "actions": [],
            "name": name || "New Custom Script",
            "parent": null,
            "key": generateScriptKey()
        };
    }

    // --- PARSER / COMPILER / INTELLISENSE ---

    function decompile(json) {
        if (!json) return "// New Script\n\n";
        let code = `// Script: ${json.name || 'Untitled'}\n// Key: ${json.key}\n\n`;

        function parseVal(v) {
            if (v === null || v === undefined) return "null";
            if (typeof v === 'string') return `"${v}"`;
            if (typeof v === 'number' || typeof v === 'boolean') return v;
            if (Array.isArray(v)) return `[${v.map(parseVal).join(', ')}]`;
            if (typeof v === 'object') {
                if (v.function) { 
                    // It's a param. Check if it has arguments.
                    const args = Object.keys(v).filter(k => k !== 'function');
                    if(args.length === 0) {
                        return `${v.function}()`; // Getter style: thisEntity()
                    } else {
                        // Complex style: ownerOfUnit({ unit: ... })
                        const argStr = args.map(k => `${k}: ${parseVal(v[k])}`).join(', ');
                        return `${v.function}({ ${argStr} })`;
                    }
                }
                return `{ ${Object.keys(v).map(k => `${k}: ${parseVal(v[k])}`).join(', ')} }`;
            }
            return "null";
        }

        function parseAction(act, indent = "") {
            if (act.type === 'comment') return `${indent}// ${act.comment}`;
            if (act.type === 'if') {
                return `${indent}if (${JSON.stringify(act.conditions)}) {\n${act.actions.map(a => parseAction(a, indent + "  ")).join('\n')}\n${indent}} else {\n${act.elseActions ? act.elseActions.map(a => parseAction(a, indent + "  ")).join('\n') : ''}\n${indent}}`;
            }
            if (act.type && act.type.startsWith('for')) {
                return `${indent}${act.type} {\n${act.actions.map(a => parseAction(a, indent + "  ")).join('\n')}\n${indent}}`;
            }
            if (act.type === 'while') {
                return `${indent}while (${JSON.stringify(act.conditions)}) {\n${act.actions.map(a => parseAction(a, indent + "  ")).join('\n')}\n${indent}}`;
            }
            // Standard Action
            const args = Object.keys(act).filter(k => k !== 'type' && k !== 'runMode' && k !== 'actions').map(k => `${k}: ${parseVal(act[k])}`).join(', ');
            return `${indent}${act.type}({ ${args} });`;
        }

        if (json.actions) code += json.actions.map(a => parseAction(a)).join('\n');
        return code;
    }

    function compile(jsCode, originalMeta) {
        // Definition Phase: Params now handle optional args
        const paramDefs = MODD_PARAMS.map(p => 
            `const ${p} = (args) => { return { function: "${p}", ...(args || {}) }; };`
        ).join('\n');

        // Action Definitions
        const actionDefs = MODD_ACTIONS.map(a => 
            `const ${a} = (args) => { 
                let obj = { type: "${a}", ...(args || {}) };
                if (obj.actions === undefined && ["if","while","repeat","for"].some(k => "${a}".startsWith(k))) obj.actions = [];
                __COLLECTOR__.push(obj); 
                return obj;
             };`
        ).join('\n');

        const wrappedCode = `
            const __COLLECTOR__ = [];
            ${paramDefs}
            ${actionDefs}
            // --- User Code ---
            ${jsCode}
            // -----------------
            return __COLLECTOR__;
        `;

        try {
            const buildFn = new Function(wrappedCode);
            const actions = buildFn();
            return {
                triggers: originalMeta?.triggers || [],
                conditions: originalMeta?.conditions || [{ "operator": "==", "operandType": "boolean" }, true, true],
                actions: actions,
                name: originalMeta?.name || "New Script",
                parent: originalMeta?.parent || null,
                key: originalMeta?.key || generateScriptKey(),
                order: originalMeta?.order || 0
            };
        } catch (e) {
            throw new Error("Compilation Failed: " + e.message);
        }
    }

    // --- LIBRARY MANAGER CLASS ---
    class SupaLibrary {
        constructor() {
            this.initData();
            this.initWatcher();
        }

        initData() {
            if (window.GM_getValue) {
                LIBRARY_DATA = window.GM_getValue('supa_lib_data', DEFAULT_LIB);
            } else {
                const stored = localStorage.getItem('SUPA_supa_lib_data');
                LIBRARY_DATA = stored ? JSON.parse(stored) : DEFAULT_LIB;
            }
        }

        saveData() {
            if (window.GM_setValue) window.GM_setValue('supa_lib_data', LIBRARY_DATA);
            else localStorage.setItem('SUPA_supa_lib_data', JSON.stringify(LIBRARY_DATA));
        }

        initWatcher() {
            setInterval(() => {
                const selects = document.querySelectorAll('select.custom-input');
                selects.forEach(sel => {
                    const hasTree = Array.from(sel.options).some(o => o.value == "0");
                    const hasJson = Array.from(sel.options).some(o => o.value == "2");
                    if (hasTree && hasJson && !sel.querySelector('option[value="3"]')) {
                        const opt = document.createElement('option');
                        opt.value = "3";
                        opt.innerText = "Inline Script (Supa)";
                        opt.style.fontWeight = "bold";
                        opt.style.color = "#ef4444";
                        sel.appendChild(opt);
                        sel.addEventListener('change', async (e) => {
                            if (e.target.value === "3") {
                                let currentJson = null;
                                if (window.unsafeWindow && window.unsafeWindow.monaco) {
                                    const eds = window.unsafeWindow.monaco.editor.getEditors();
                                    if (eds.length > 0) { try { currentJson = JSON.parse(eds[0].getValue()); } catch (err) {} }
                                }
                                e.target.value = "0"; //
                                e.target.dispatchEvent(new Event('change', { bubbles: true }));
                                this.openInlineEditor(currentJson);
                            }
                        });
                    }
                });
            }, 1000);
        }

        renderLibList(filter = '') {
            const list = document.querySelector('.supa-lib-list');
            if (!list) return;
            list.innerHTML = '';

            const renderItems = (items, container, isUserFolder = false) => {
                items.forEach(item => {
                    if (filter && item.type === 'script' && !item.name.toLowerCase().includes(filter.toLowerCase())) return;
                    if (item.type === 'folder') {
                        const group = document.createElement('div');
                        group.className = 'folder-group';
                        const header = document.createElement('div');
                        header.className = 'folder-header';
                        header.innerHTML = `<span>${item.isOpen ? 'üìÇ' : 'üìÅ'}</span> ${item.name}`;
                        header.onclick = () => { item.isOpen = !item.isOpen; this.saveData(); this.renderLibList(filter); };
                        const content = document.createElement('div');
                        content.className = 'folder-content' + (item.isOpen || filter ? ' open' : '');
                        if (item.children && item.children.length > 0) renderItems(item.children, content, item.id === 'user_folder');
                        else content.innerHTML = '<div style="font-size:10px; opacity:0.3; padding:5px;">Empty</div>';
                        group.appendChild(header); group.appendChild(content); container.appendChild(group);
                    } else {
                        const el = document.createElement('div');
                        el.className = 'supa-lib-item';
                        el.innerHTML = `<span>${item.icon || 'üìÑ'}</span> <span>${item.name}</span>`;
                        if (isUserFolder) {
                            const delBtn = document.createElement('span');
                            delBtn.className = 'supa-item-del';
                            delBtn.innerHTML = 'üóëÔ∏è';
                            delBtn.onclick = (e) => { e.stopPropagation(); this.deleteScript(item.id); };
                            el.appendChild(delBtn);
                        }
                        el.onclick = () => this.loadScriptIntoEditor(item);
                        container.appendChild(el);
                    }
                });
            };
            renderItems(LIBRARY_DATA, list);
        }

        deleteScript(scriptId) {
            if (!confirm("Are you sure?")) return;
            const userFolder = LIBRARY_DATA.find(f => f.id === 'user_folder');
            if (userFolder) {
                userFolder.children = userFolder.children.filter(s => s.id !== scriptId);
                this.saveData();
                this.renderLibList();
            }
        }

        addScriptToFolder(folderId, scriptObj) {
            const target = LIBRARY_DATA.find(f => f.id === folderId) || LIBRARY_DATA[1];
            if(!target.children) target.children = [];
            target.children.push(scriptObj);
            this.saveData();
            this.renderLibList();
        }

        collectCurrentScript() {
            if (window.unsafeWindow && window.unsafeWindow.monaco) {
                const eds = window.unsafeWindow.monaco.editor.getEditors();
                if (eds.length > 0) {
                    try {
                        const json = JSON.parse(eds[0].getValue());
                        const name = prompt("Script Name:", json.name || "Collected Script");
                        const emoji = prompt("Icon:", "üíæ") || "üíæ";
                        if (name) {
                            json.name = name;
                            this.addScriptToFolder('user_folder', { id: 'saved_' + Date.now(), name: name, type: 'script', icon: emoji, json: json });
                        }
                    } catch (e) { alert("Invalid JSON!"); }
                } else alert("No editor found.");
            }
        }

        loadScriptIntoEditor(scriptData) {
            const newBtn = Array.from(document.querySelectorAll('button')).find(b => b.textContent.includes('New Script'));
            if (!newBtn) { alert("Select Scripts tab!"); return; }
            newBtn.click();
            let attempts = 0;
            const waitForUI = setInterval(() => {
                attempts++;
                const select = document.querySelector('select.custom-input');
                if (select || attempts > 20) {
                    clearInterval(waitForUI);
                    if (!select) return;
                    select.value = "2";
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    setTimeout(() => {
                        let finalJson = scriptData.json || getDefaultScript(scriptData.name);
                        if (scriptData.json) { finalJson.key = generateScriptKey(); finalJson.name = scriptData.name; }
                        const content = JSON.stringify(finalJson, null, 4);
                        if (window.unsafeWindow && window.unsafeWindow.monaco) {
                            const eds = window.unsafeWindow.monaco.editor.getEditors?.() || [];
                            if (eds[0]?.getModel()) { eds[0].getModel().setValue(content); return; }
                        }
                        select.value = "0";
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                    }, 600);
                }
            }, 100);
        }

        openCustomCreator() {
            const modal = document.createElement('div');
            modal.className = 'supa-modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-box">
                    <h3 style="margin:0; color:white;">Create Custom Script</h3>
                    <input class="modal-input" id="cust-name" placeholder="Script Name">
                    <input class="modal-input" id="cust-icon" placeholder="Emoji" maxlength="2">
                    <textarea class="modal-textarea" id="cust-json" placeholder="JSON (optional)"></textarea>
                    <div style="display:flex; gap:10px;"><button class="btn-action" id="cust-save">Save</button><button class="btn-action" style="background:#222;" id="cust-cancel">Cancel</button></div>
                </div>`;
            document.body.appendChild(modal);
            document.getElementById('cust-cancel').onclick = () => modal.remove();
            document.getElementById('cust-save').onclick = () => {
                const name = document.getElementById('cust-name').value || "Untitled";
                const icon = document.getElementById('cust-icon').value || "üõ†";
                let json = null;
                try { 
                    if (document.getElementById('cust-json').value.trim()) json = JSON.parse(document.getElementById('cust-json').value); 
                } catch (e) { alert("Invalid JSON"); return; }
                this.addScriptToFolder('user_folder', { id: 'custom_' + Date.now(), name: name, type: 'script', icon: icon, json: json });
                modal.remove();
            };
        }

        openInlineEditor(originalJson) {
            const modal = document.createElement('div');
            modal.className = 'supa-modal';
            modal.style.display = 'flex';
            modal.style.zIndex = '999999';
            modal.innerHTML = `
                <div class="modal-box" style="width: 80vw; height: 80vh; max-width: none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; color:white;">Inline Script Editor</h3>
                        <input id="inline-name" value="${originalJson?.name || 'New Script'}" style="background:transparent; border:1px solid var(--border); color:white; padding:5px; border-radius:5px;">
                    </div>
                    <div id="monaco-container" style="flex:1; border:1px solid var(--border); border-radius:8px; overflow:hidden;"></div>
                    <div style="display:flex; gap:10px; justify-content:flex-end;"><button class="btn-action" style="width:auto; background:#222;" id="inline-cancel">Cancel</button><button class="btn-action" style="width:auto;" id="inline-save">Save & Compile</button></div>
                </div>`;
            document.body.appendChild(modal);

            if (window.unsafeWindow && window.unsafeWindow.monaco) {
                // AUTOCOMPLETE CONFIG
                const disposable = window.unsafeWindow.monaco.languages.registerCompletionItemProvider('javascript', {
                    provideCompletionItems: function(model, position) {
                        var word = model.getWordUntilPosition(position);
                        var range = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
                        
                        const suggestions = [
                            ...MODD_ACTIONS.map(a => ({
                                label: a,
                                kind: window.unsafeWindow.monaco.languages.CompletionItemKind.Function,
                                insertText: a + '({  })',
                                detail: 'Action',
                                documentation: { value: `**Action**: ${a}\n\n[Open Documentation](https://github.com/moddio/moddio-docs/tree/main/scripting-reference)` },
                                range: range
                            })),
                            ...MODD_PARAMS.map(p => {
                                // Smart Insert: If it's a known 0-arg param like "thisEntity", use (), else ({})
                                const isZeroArg = ["thisEntity", "lastTriggeringUnit", "allPlayers", "allUnitsInGame"].some(x => p.startsWith(x));
                                return {
                                    label: p,
                                    kind: window.unsafeWindow.monaco.languages.CompletionItemKind.Variable,
                                    insertText: isZeroArg ? p + '()' : p + '({  })',
                                    detail: 'Param (Returns Object)',
                                    documentation: { value: `**Param**: ${p}\n\n[Open Documentation](https://github.com/moddio/moddio-docs/tree/main/scripting-reference)` },
                                    range: range
                                };
                            })
                        ];
                        return { suggestions: suggestions };
                    }
                });

                const editor = window.unsafeWindow.monaco.editor.create(document.getElementById('monaco-container'), {
                    value: decompile(originalJson),
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: true }
                });

                document.getElementById('inline-save').onclick = () => {
                    try {
                        const finalJson = compile(editor.getValue(), { ...originalJson, name: document.getElementById('inline-name').value });
                        const select = document.querySelector('select.custom-input');
                        if (select) {
                            select.value = "2";
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            setTimeout(() => {
                                if (window.unsafeWindow.monaco) {
                                    const eds = window.unsafeWindow.monaco.editor.getEditors();
                                    if (eds[0]) eds[0].setValue(JSON.stringify(finalJson, null, 4));
                                }
                                modal.remove();
                                disposable.dispose();
                            }, 200);
                        }
                    } catch (e) { alert("Compilation Error:\n" + e.message); }
                };
                document.getElementById('inline-cancel').onclick = () => { modal.remove(); disposable.dispose(); };
            }
        }

        injectLibraryUI() {
            let target = document.querySelector('[id*="editor-script-"]');
            if (!target) target = document.querySelector('winbox entities-window focus no-full max');
            if(!target || target.parentElement.querySelector('.supa-script-lib')) return;
            
            const parent = target.parentElement;
            parent.style.display = 'flex'; parent.style.flexDirection = 'row';
            
            const lib = document.createElement('div');
            lib.className = 'supa-script-lib';
            lib.innerHTML = `
                <div class="supa-lib-arrow" title="Toggle Library">‚óÄ</div>
                <div class="supa-lib-header">Supa Library <span style="font-size:9px; opacity:0.5;">v3.1</span></div>
                <div class="supa-lib-tools">
                    <input class="supa-tool-input" placeholder="Search scripts..." id="lib-search">
                    <div class="supa-tool-btn" id="btn-create">+</div><div class="supa-tool-btn" id="btn-collect">‚¨á</div>
                </div>
                <div class="supa-lib-list"></div>`;
            parent.insertBefore(lib, target);
            target.style.flex = "1"; target.style.width = "auto";
            
            lib.querySelector('.supa-lib-arrow').onclick = () => { lib.classList.toggle('collapsed'); lib.querySelector('.supa-lib-arrow').innerText = lib.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ'; };
            document.getElementById('lib-search').oninput = (e) => this.renderLibList(e.target.value);
            document.getElementById('btn-collect').onclick = () => this.collectCurrentScript();
            document.getElementById('btn-create').onclick = () => this.openCustomCreator();
            this.renderLibList();
        }
    }

    // Export instance
    window.SupaLibInstance = new SupaLibrary();

})(window);
