/* ==========================================================================
   SUPA HUB LIBRARY & PARSER MODULE
   Features:
   - Fixed "Unexpected token if" by quoting keys and improving sandbox scope
   - Functional Compiler with reserved keyword protection
   - Improved Decompiler (now quotes 'if' key)
   ========================================================================== */

(function(global) {
    'use strict';

    const MODD_ACTIONS = ["if", "else", "then", "killThisGameInstance", "return", "sendPostRequest", "sendSecurePostRequest", "break", "forAllElementsInAnObject", "forAllEntitiesInAnEntityGroup", "forAllItemTypesInAnItemTypeGroup", "forAllItemsInAItemGroup", "forAllPlayersInAPlayerGroup", "forAllProjectilesInAProjectileGroup", "forAllPropsInAPropGroup", "forAllRegionsInARegionGroup", "forAllUnitTypesInAUnitTypeGroup", "forAllUnitsInAUnitGroup", "forInLoop", "forLoop", "repeatXTimes", "repeatXTimesWithDelay", "skipIteration", "while", "runEntityScript", "runEntityScriptOnClient", "runScript", "runScriptOnClient", "addNewBotPlayer", "changeAIUnitPathfindingMethod", "commandAIUnitToAttackUnit", "commandAIUnitToGoIdle", "commandAIUnitToMoveToPosition", "disableAI", "enableAI", "setUnitLetGoDistance", "setUnitMaxAttackRange", "setUnitMaxTravelDistance", "addWordsToChatFilter", "makePlayerSendChatMessage", "sendModdCoinsToPlayer", "askPlayerToJoinCompetition", "endCompetitionAndDistributeRewards", "startAcceptingPlayersForCompetition", "setAmbientLightColor", "setAmbientLightIntensity", "setDirectionalLightColor", "setDirectionalLightIntensity", "setDirectionalLightPosition", "setFogColor", "setFogDensity", "setFogEnabled", "setFogFar", "setFogNear", "setGravity", "setSkyboxOpacity", "changeLayerOpacity", "editMapTile", "editMapTiles", "loadMapFromString", "promptLoginModalForPlayer", "saveCurrentMapState", "sendDataFromClientToServer", "sendDataFromServerToClient", "addQuestToPlayer", "completeQuest", "removeQuestForPlayer", "setQuestProgress", "toggleOutlineOnEntity", "renderLineBetweenPositions", "openWalletConnectInterfaceForPlayer", "fetchTreasuryTokenBalance", "sendPlayerGroupToDifferentMap", "sendPlayerToDifferentMap", "sendPlayerToGame", "sendPlayerToLastSpawningMap", "playVideoAdForEveryone", "playVideoAdForPlayer", "makeCameraLookAtPosition", "makePlayerCameraStopTrackingUnit", "makePlayerCameraTrackUnit", "setCameraDeadzone", "setPlayerCameraPitch", "setPlayerCameraYaw", "setPlayerCameraZoom", "unlockCameraPointer", "closeDialogueForPlayer", "openDialogueForPlayer", "activateEntity", "applyForceOnEntityXY", "applyForceOnEntityXYLossTolerant", "applyForceOnEntityXYRelative", "applyForceOnEntityAtAngle", "applyForceOnEntityAtAngleLossTolerant", "applyImpulseOnEntityXY", "applyImpulseOnEntityAtAngle", "applyImpulseOnEntityInDirection", "applyTorqueOnEntity", "applyTorqueOnEntityToFacePosition", "changeModelSprite", "changeScaleOfEntityBody", "changeScaleOfEntitySpriteModel", "changeColorOfEntity", "createEntityAtPosition", "createEntityAtPosition2d", "createEntityAtPositionWithDimension", "deactivateEntity", "destroyEntity", "flipEntitySprite", "hideEntity", "moveEntity", "playEntityAnimation", "rotateEntity3d", "rotateEntityToFacePositionInstantly", "rotateEntityToRadians", "setEntityAttributeMaxValue", "setEntityAttributeMinValue", "setEntityAttributeRegenerationRate", "setEntityAttributeValue", "setEntityLifeSpan", "setEntityOpacity", "setEntityState", "setEntityVelocityAtAngle", "setEntityVelocityInDirection", "setEntityZOffset", "setVelocityOfEntityXY", "showEntity", "stopPlayingAllEntityAnimations", "stopPlayingEntityAnimation", "teleportEntity", "changeDescriptionOfItem", "changeItemInventorySlotColor", "createItemAtPosition", "createItemWithMaxQuantityAtPosition", "disableItemRotationFacingMouseCursor", "dropItemAtPosition", "enableItemRotationFacingMouseCursor", "giveNewItemToUnit", "giveNewItemToUnitWithQuantity", "playItemTween", "setFireRateOfItem", "setItemInventoryImage", "setItemName", "setLastAttackingItem", "startUsingItem", "stopUsingItem", "updateItemQuantity", "useItemOnce", "playMusicForEveryone", "playMusicForPlayer", "playMusicForPlayerAtTime", "playMusicForPlayerRepeatedly", "stopMusicForEveryone", "stopMusicForPlayer", "decreaseVariableByNumber", "increaseVariableByNumber", "addBooleanElementIntoObject", "addNumberElementIntoObject", "addObjectElementIntoObject", "addStringElementIntoObject", "removeElementFromObject", "startEmittingParticles", "stopEmittingParticles", "applyLoadedUserDataToPlayerAndUnit", "assignPlayerToPlayerType", "hideGameSuggestions", "kickPlayer", "loadPlayerDataFromString", "makePlayerInitiateItemTradeWithPlayer", "makePlayerSelectUnit", "mutePlayerFromChat", "openWebsiteForPlayer", "savePlayerData", "setPlayerAttributeMaxValue", "setPlayerAttributeMinValue", "setPlayerAttributeRegenerationRate", "setPlayerAttributeValue", "setPlayerName", "showGameSuggestions", "startAcceptingPlayers", "stopAcceptingPlayers", "unmutePlayerFromChat", "addPlayerToPlayerGroup", "removePlayerFromPlayerGroup", "createProjectileAtPosition", "setSourceItemOfProjectile", "setSourceUnitOfProjectile", "createPropAtPosition", "changeRegionColor", "transformRegion", "changeSensorRadius", "closeShopForPlayer", "openShopForPlayer", "openSkinShopForPlayer", "openSkinSubmissionPageForPlayer", "triggerPurchaseOfItemFromShopForPlayer", "playSoundAtPosition", "playSoundForPlayer", "stopSoundForPlayer", "setTimeout", "addClassToUIElement", "appendRealtimeCSSForPlayer", "closeBackpackForPlayer", "comment", "createDynamicFloatingText", "createFloatingText", "createFloatingTextOnUnit", "hideUIElementForPlayer", "hideOverlayTextForEveryone", "hideOverlayTextForPlayer", "openBackpackForPlayer", "removeClassFromUIElement", "sendChatMessage", "sendChatMessageToPlayer", "setUIElementProperty", "setInnerHTMLOfUIElementWithID", "setUnitNameLabel", "setUnitNameLabelColorForPlayer", "showUIElementForPlayer", "showCustomModalToPlayer", "showDismissibleInputModalToPlayer", "showInputModalToPlayer", "showInviteFriendsModalToPlayer", "showMenu", "showMenuAndSelectBestServer", "showMenuAndSelectCurrentlyConnectedServer", "showOverlayTextForEveryone", "showOverlayTextForPlayer", "updateOverlayTextForXMilliseconds", "updateOverlayTextForEveryone", "updateOverlayTextForPlayer", "updateRealtimeCSSForPlayer", "addAttributeBuffToUnit", "changeUnitType", "createUnitAtPosition", "dropAllItems", "dropItemInInventoryAtSlot", "hideMinimapUnit", "hideUnitNameLabelFromHostilePlayers", "hideUnitNameLabelFromPlayer", "hideUnitUI", "loadUnitDataFromString", "makeUnitCastAbilityOnce", "makeUnitInvisibleToFriendlyPlayers", "makeUnitInvisibleToHostilePlayers", "makeUnitInvisibleToNeutralPlayers", "makeUnitPickUpItem", "makeUnitSelectItemAtSlot", "makeUnitVisibleToFriendlyPlayers", "makeUnitVisibleToHostilePlayers", "makeUnitVisibleToNeutralPlayers", "moveUnitDown", "moveUnitLeft", "moveUnitRight", "moveUnitUp", "removeAllAttributeBuffsFromUnit", "saveUnitData", "setLastAttackedUnit", "setLastAttackingUnit", "setOwnerOfUnit", "showUnitInMinimap", "showUnitNameLabelToHostilePlayers", "showUnitNameLabelToPlayer", "showUnitUI", "startCastingAbility", "stopCastingAbility", "stopMovingUnit", "stopUnitX", "stopUnitY", "addUnitToUnitGroup", "removeUnitFromUnitGroup", "sendUtilityTokensToPlayer"];
    const MODD_PARAMS = ["globalVariable", "playerVariable", "lastTriggeringAttribute", "attributeTypeOfAttribute", "entityExistsInGame", "isCircleOccupied", "isEntityServerCulled", "isPlayerLocalClient", "isPlayerAiAgent", "isPlayerOnMobile", "isPositionInWall", "isQuestActive", "isQuestCompleted", "isRectangleOccupied", "isUnitMoving", "itemFiresProjectiles", "notValue", "objectContainsElement", "playerHasAdblockEnabled", "playerIsControlledByBot", "playerIsControlledByHumanBot", "playerIsControlledByComputer", "playerIsHostileAgainstAnotherPlayer", "playerIsLoggedIn", "playerIsNeutralToAnotherPlayer", "playerIsCreator", "playersIsFriendlyToAnotherPlayer", "regionOverlapsWithRegion", "roleNameExistsForPlayer", "stringContainsString", "stringEndsWithString", "stringIsNumber", "stringStartsWithString", "unitHasAIEnabled", "unitIsCarryingItemOfItemType", "getEntityFromId", "lastCreatedProp", "lastTouchedProp", "lastTriggeringEntity", "lastTriggeringProp", "selectedEntity", "thisEntity", "allEntitiesInGame", "entitiesBetweenTwoPositions", "entitiesCollidingWithLastTriggeringRaycast", "entitiesInRegion", "entitiesInRegionWidthHeightInFrontOfEntityAtDistance", "itemCurrentlyHeldByUnit", "itemInInventorySlot", "lastAttackingItem", "lastCreatedItem", "lastTouchedItem", "lastTriggeringItem", "lastUsedItem", "selectedItem", "sourceItemOfProjectile", "allItemsDroppedOnGround", "allItemsInGame", "allItemsOfItemType", "allItemsOwnedByUnit", "getItemTypeFromStringId", "itemTypeOfItem", "randomItemTypeFromItemTypeGroup", "selectedItemType", "allItemTypesInGame", "absoluteValueOfNumber", "angleBetweenPlayerMouseCursorAndCenterOfWindow", "angleBetweenPositions", "arctanOfAngle", "arrayLength", "cameraHeightLocal", "cameraWidthLocal", "convertDegreesIntoRadians", "convertRadiansToDegrees", "cosOfAngle", "currentTime", "defaultAttributeValueOfUnitType", "defaultQuantityOfItemType", "distanceBetweenPositions", "entityAttributeMax", "entityAttributeMin", "entityAttributePreviousValue", "entityAttributeRegenerationRate", "entityAttributeValue", "entityBodyHeight", "entityBodyWidth", "entityOpacity", "entityVelocityX", "entityVelocityY", "entityVelocityZ", "entityFacingAngle", "exponentValue", "fireRateOfItemType", "getCameraPitch", "getCameraYaw", "getQuestProgress", "heightOfRegion", "itemQuantity", "itemQuantityMax", "lastFetchedTreasuryTokenBalance", "lastPlayerCompetitionParticipationCost", "lastPlayerCompetitionRewardAmount", "lengthOfString", "lerp", "logBase10", "mapTileIDAtPosition", "mapHeight", "mapWidth", "mathCeiling", "mathFloor", "mathRound", "mathSign", "maxQuantityOfItemType", "maximumValueBetweenTwoNumbers", "minimumValueBetweenTwoNumbers", "numberAtFixedDecimalPlaces", "numberConvertedFromString", "numberOfAllUnitsInGame", "numberOfElementsInObject", "numberOfHumanPlayers", "numberOfInvitesByPlayer", "numberOfItemsPresent", "numberOfPlayersOfPlayerType", "numberOfUnitsOfUnitType", "playerAttributeMax", "playerAttributeMin", "playerAttributeRegenerationRate", "playerAttributeValue", "playerHighScore", "playerLastPlayedTime", "quantityOfItemTypeInItemTypeGroup", "quantityOfUnitTypeInUnitTypeGroup", "randomNumber", "rotateSpeedOfUnitType", "selectedInventorySlot", "serverAge", "serverStartTime", "sinOfAngle", "squareRoot", "tanOfAngle", "unitSensorRadius", "unitTypeDefaultHeight", "unitTypeDefaultWidth", "unitFacingAngle", "widthOfRegion", "xCoordinateOfPosition", "xCoordinateOfRegion", "yCoordinateOfPosition", "yCoordinateOfRegion", "zCoordinateOfPosition", "elementFromObject", "emptyObject", "getAllActiveQuestObjects", "getAllActiveQuestObjectsInThisMap", "getQuestObject", "lastDataReceivedFromClientForPlayer", "lastDataReceivedFromServer", "lastRequestedCompetitionDetails", "lastRequestedCompetitionParticipants", "lastTokenSwapInfoForPlayer", "objectConvertedFromString", "purchasedItemDetails", "selectedElement", "thisRequestData", "itemParticle", "computerPlayer", "getPlayerByUserId", "getPlayerFromId", "lastPlayerSelectingDialogueOption", "lastTriggeringPlayer", "localPlayer", "ownerOfUnit", "selectedPlayer", "allPlayers", "allPlayersOfPlayerType", "botPlayers", "computerPlayers", "humanPlayers", "playerTypeOfPlayer", "cameraPositionLocal", "centerOfRegion", "entityPosition", "lerpPosition", "mobileSecondaryTouchPositionLocal", "mouseCursorPosition", "mouseCursorPositionInWorldSpace", "positionInFrontOfPosition", "randomPositionInRegion", "xyCoordinate", "lastCreatedProjectile", "lastOverlappingProjectile", "lastTouchedProjectile", "lastTriggeringProjectile", "selectedProjectile", "allProjectilesInGame", "allProjectilesOfProjectileType", "getProjectileTypeFromStringId", "projectileTypeOfItemType", "projectileTypeOfProjectile", "selectedProp", "allPropsInGame", "allPropsOfPropType", "dynamicRegion3d", "dynamicRegion", "entireMapRegion", "entityBounds", "lastTriggeringRegion", "regionWithMatchingName", "selectedRegion", "allRegionsInGame", "lastTriggeringSensor", "unitSensor", "currentStateOfEntity", "UIElementPropertyLocal", "animationsPlayingByEntity", "arrayElement", "concatenate", "entityCategory", "entityId", "gameId", "getPlayerAgentId", "insertElementIntoArray", "inventoryURLOfItemType", "itemDescription", "lastChatMessageSentByPlayer", "lastClickedUIElementIDByPlayer", "lastPlayerCustomInput", "lastReceivedPOSTResponse", "lastTriggeringQuestId", "lastUpdatedVariableName", "mapJson", "nameOfEntity", "nameOfItemType", "nameOfPlayer", "nameOfRegion", "nameOfUnitType", "numberConvertedToLargeNumberNotation", "playerCurrentDialogue", "playerData", "playerId", "playerUsername", "playerWalletAddress", "realtimeCSSOfPlayer", "removeArrayElement", "replaceValueInString", "selectedElementKey", "stringConvertedFromNumber", "stringConvertedFromObject", "substringOf", "timeString", "toLowerCase", "toUpperCase", "unitData", "unitTypeDefaultModelSprite", "updateArrayElement", "globalVariableByName", "entityTint", "entityVariable", "undefinedValue", "lastAbilityCastingUnit", "lastAttackedUnit", "lastAttackingUnit", "lastCreatedUnit", "lastPurchasedUnit", "lastTouchedUnit", "lastTouchingUnit", "lastTriggeringUnit", "ownerOfItem", "ownerUnitOfSensor", "playerCurrentlySelectedUnit", "selectedUnit", "sourceUnitOfProjectile", "targetUnitOfUnit", "allUnitsInRegion", "allUnitsInGame", "allUnitsOfUnitType", "allUnitsOwnedByPlayer", "getUnitTypeFromStringID", "randomUnitTypeFromUnitTypeGroup", "selectedUnitType", "unitTypeOfLastPurchasedUnit", "unitTypeOfUnit", "allUnitTypesInGame", "centerOfRegion3d", "directionVectorBetweenPositions", "entityPosition3d", "entityRotation3d", "entityLastRaycastCollidingPosition", "entityLastRaycastStartPosition", "lerpPosition3d", "positionInFrontOfPosition3d", "randomPositionInRegion3d", "unitAIOriginalPosition", "vectorBetweenPositions", "vector3"];

    function decompile(json) {
        if (!json) return "// New Script\n\n";
        let code = `// Script: ${json.name || 'Untitled'}\n\n`;
        function parseVal(v) {
            if (v === null || v === undefined) return "null";
            if (typeof v === 'string') return `"${v}"`;
            if (typeof v === 'number' || typeof v === 'boolean') return v;
            if (Array.isArray(v)) return `[${v.map(parseVal).join(', ')}]`;
            if (typeof v === 'object') {
                if (v.function) {
                    const keys = Object.keys(v).filter(k => k !== 'function');
                    if (keys.length === 0) return `${v.function}()`;
                    return `${v.function}({ ${keys.map(k => `${k}: ${parseVal(v[k])}`).join(', ')} })`;
                }
                const objKeys = Object.keys(v);
                return `{ ${objKeys.map(k => `${k}: ${parseVal(v[k])}`).join(', ')} }`;
            }
            return "null";
        }
        function parseAction(act, indent = "") {
            if (!act) return "";
            if (act.type === 'comment') return `${indent}comment({ comment: "${act.comment || ''}" });`;
            if (act.type === 'if') {
                const cond = act.conditions ? JSON.stringify(act.conditions) : '[]';
                const main = act.actions?.map(a => parseAction(a, indent + "  ")).join('\n') || "";
                const els = act.elseActions?.map(a => parseAction(a, indent + "  ")).join('\n') || "";
                // Use quotes for 'if' key to prevent JS parser errors
                return `${indent}condition({ \n${indent}  "if": ${cond}, \n${indent}  then: [\n${main}\n${indent}  ], \n${indent}  else: [\n${els}\n${indent}  ]\n${indent}});`;
            }
            const keys = Object.keys(act).filter(k => !['type', 'runMode', 'actions', 'elseActions'].includes(k));
            const args = keys.map(k => `${k}: ${parseVal(act[k])}`).join(', ');
            return `${indent}${act.type}({ ${args} });`;
        }
        if (json.actions) code += json.actions.map(a => parseAction(a)).join('\n');
        return code;
    }

    function compile(jsCode, meta) {
        const paramFuncs = MODD_PARAMS.map(p => `const ${p} = (args) => ({ function: "${p}", ...(args || {}) });`).join('\n');
        const actionFuncs = MODD_ACTIONS.map(a => {
            if (a === 'if') return `const condition = (args) => { const obj = { type: "if", conditions: args.if || args["if"] || [], actions: args.then || [], elseActions: args.else || [] }; __ACTIONS__.push(obj); return obj; };`;
            return `const ${a} = (args) => { const obj = { type: "${a}", ...(args || {}) }; __ACTIONS__.push(obj); return obj; };`;
        }).join('\n');

        const sandbox = `
            const __ACTIONS__ = [];
            ${paramFuncs}
            ${actionFuncs}
            
            // Execute user code
            ${jsCode}
            
            return __ACTIONS__;
        `;

        try {
            const runner = new Function(sandbox);
            const compiledActions = runner();
            return {
                ...meta,
                actions: compiledActions,
                key: meta?.key || Math.random().toString(36).substring(7)
            };
        } catch (e) {
            // Provide a clearer error message if the user still uses 'if' as a statement
            if (e.message.includes("Unexpected token 'if'")) {
                 throw new Error("Compilation Error: You cannot use native 'if' statements. Use the 'condition({...})' function instead.");
            }
            throw new Error("Compilation Failed: " + e.message);
        }
    }

    class SupaLibrary {
        constructor() { this.initWatcher(); }
        initWatcher() {
            setInterval(() => {
                const selects = document.querySelectorAll('select.custom-input');
                selects.forEach(sel => {
                    if (!sel.querySelector('option[value="3"]')) {
                        const opt = document.createElement('option');
                        opt.value = "3"; opt.innerText = "Inline Script (Supa)"; opt.style.color = "#ef4444";
                        sel.appendChild(opt);
                        sel.addEventListener('change', (e) => {
                            if (e.target.value === "3") {
                                e.target.value = "0";
                                e.target.dispatchEvent(new Event('change', { bubbles: true }));
                                this.openEditor();
                            }
                        });
                    }
                });
            }, 1000);
        }

        openEditor() {
            let currentJson = null;
            if (window.unsafeWindow?.monaco) {
                const eds = window.unsafeWindow.monaco.editor.getEditors();
                if (eds[0]) { try { currentJson = JSON.parse(eds[0].getValue()); } catch(e){} }
            }

            const modal = document.createElement('div');
            modal.style = "position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:999999; display:flex; align-items:center; justify-content:center; padding:50px;";
            modal.innerHTML = `
                <div style="background:#0a0a0e; border:1px solid #333; border-radius:15px; width:100%; height:100%; display:flex; flex-direction:column; overflow:hidden;">
                    <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; color:white; font-weight:bold;">
                        <span>Inline Script Editor (Supa)</span>
                        <button id="close-supa-editor" style="background:none; border:none; color:white; cursor:pointer;">âœ•</button>
                    </div>
                    <div id="supa-monaco-container" style="flex:1;"></div>
                    <div style="padding:15px; background:#0f0f12; border-top:1px solid #333; display:flex; justify-content:flex-end; gap:10px;">
                        <button id="supa-compile-btn" style="background:#ef4444; color:white; border:none; padding:10px 20px; border-radius:5px; font-weight:bold; cursor:pointer;">Compile & Save</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            if (window.unsafeWindow?.monaco) {
                const langId = 'javascript';
                const disposable = window.unsafeWindow.monaco.languages.registerCompletionItemProvider(langId, {
                    provideCompletionItems: (model, position) => {
                        const word = model.getWordUntilPosition(position);
                        const range = { startLineNumber: position.lineNumber, endLineNumber: position.lineNumber, startColumn: word.startColumn, endColumn: word.endColumn };
                        const suggestions = [
                            { label: 'condition', kind: 11, insertText: 'condition({\n  "if": [],\n  then: [],\n  else: []\n})', detail: 'Modd If/Else', range },
                            ...MODD_ACTIONS.filter(a => a !== 'if').map(a => ({
                                label: a, kind: 11, insertText: a + '({  })', detail: 'Action', range
                            })),
                            ...MODD_PARAMS.map(p => ({
                                label: p, kind: 6, insertText: ["thisEntity", "allPlayers"].includes(p) ? p + '()' : p + '({  })', detail: 'Param', range
                            }))
                        ];
                        return { suggestions };
                    }
                });

                const editor = window.unsafeWindow.monaco.editor.create(document.getElementById('supa-monaco-container'), {
                    value: decompile(currentJson),
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true
                });

                document.getElementById('close-supa-editor').onclick = () => { modal.remove(); disposable.dispose(); };
                document.getElementById('supa-compile-btn').onclick = () => {
                    try {
                        const result = compile(editor.getValue(), currentJson);
                        const mainEditor = window.unsafeWindow.monaco.editor.getEditors()[0];
                        if (mainEditor) {
                            const select = document.querySelector('select.custom-input');
                            select.value = "2";
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                            setTimeout(() => {
                                mainEditor.setValue(JSON.stringify(result, null, 4));
                                modal.remove();
                                disposable.dispose();
                            }, 100);
                        }
                    } catch (e) { alert(e.message); }
                };
            }
        }
    }
    window.SupaLibInstance = new SupaLibrary();
})(window);
