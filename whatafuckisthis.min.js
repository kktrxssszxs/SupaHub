window.GM_addStyle = css => {
    const s = document.createElement("style");
    s.textContent = css;
    document.head.appendChild(s);
};

window.GM_setValue = (k, v) => localStorage.setItem("SUPA_" + k, JSON.stringify(v));
window.GM_getValue = (k, d) => {
    const v = localStorage.getItem("SUPA_" + k);
    return v ? JSON.parse(v) : d;
};

window.unsafeWindow = window;

(function () {
    const origSend = WebSocket.prototype.send;
    WebSocket.prototype.send = function (data) {
        try {
            if (typeof data === "string") {
                if (data.startsWith("40") || data.startsWith("42")) {
                    const jsonStart = data.indexOf("{");
                    if (jsonStart !== -1) {
                        const payload = JSON.parse(data.slice(jsonStart));
                        if (
                            payload?.token &&
                            typeof payload.token === "string" &&
                            payload.token.includes("userId")
                        ) {
                            window.__SUPA_REAL_TOKEN__ = payload.token;
                        }
                    }
                }
            }
        } catch { }
        return origSend.call(this, data);
    };
})();

(function () {
    'use strict';
    if (window.__SUPA_HUB__) return;
    window.__SUPA_HUB__ = true;

    // --- CONFIGURATION ---
    const ENABLE_CHRISTMAS = true; 
    // This URL should point to the raw file of the intellisense script you uploaded or hosted
    const INLINE_SCRIPT_URL = 'https://raw.githubusercontent.com/KKTRXS/Modd.io-Supa-Hub/main/modd-intellisense.js'; 
    // ---------------------

    let localUser = { username: '', coins: 0, avatar: '', id: '' };
    let socialCache = { friends: [], following: [], followers: [], viewingUser: '' };
    let allGamesPool = [];
    let favoritesList = GM_getValue('supa_favs', []);
    let userAccent = GM_getValue('supa_accent', ENABLE_CHRISTMAS ? '#ef4444' : '#6366f1');
    let currentPath = "";
    let hasEditorAccess = false;
    let isSidebarCollapsed = false;
    let birdEl = null;
    let birdAnim = null;
    let snowInterval = null;

    // Default Library Data (Restored from previous versions)
    const DEFAULT_LIB = [
        {
            id: 'root_folder',
            name: 'Default Scripts',
            type: 'folder',
            isOpen: true,
            children: [
                { id: 'def_1', name: 'Basic Template', type: 'script', icon: 'üìÑ', json: null },
                {
                    id: 'def_2', name: 'Full Commands System', type: 'script', icon: 'üìÑ', json: {
                        "triggers": [],
                        "conditions": [
                            { "operator": "==", "operandType": "boolean" },
                            true,
                            true
                        ],
                        "actions": [{ "type": "comment", "comment": "logic", "runMode": 0 }],
                        "name": "Full Chat Command System",
                        "parent": null,
                        "key": generateScriptKey()
                    }
                }
            ]
        },
        {
            id: 'user_folder',
            name: 'My Saved Scripts',
            type: 'folder',
            isOpen: true,
            children: []
        }
    ];

    let LIBRARY_DATA = GM_getValue('supa_lib_data', DEFAULT_LIB);

    const CONFIG = {
        apiGames: 'https://www.modd.io/api/v1/games/',
        apiCreations: 'https://www.modd.io/api/v1/creations/',
        apiLocalUser: 'https://www.modd.io/api/v1/user/',
        apiPublicUser: 'https://www.modd.io/api/v1/user-by-name/',
        apiGamesByUser: 'https://www.modd.io/api/v1/games-by-user-id/',
        apiEditorCheck: (id) => `https://www.modd.io/api/game/${id}/game-data-for-creators/`,
        apiBruteEngineVersion: (id) => `https://cdn.modd.io/api/game-client/cached/${id}/1766554862629/`,
        logos: {
            big: 'https://cdn.modd.io/_next/static/media/logo.08e05f95.svg',
            small: 'https://cdn.modd.io/_next/static/media/logo-alt.3b46c8b8.svg'
        }
    };

    function attachChat() {
        console.log('[SUPA HUB] Chat system attachment is not implemented in this version.');
    }

    function removeBird() {
        if (birdEl) {
            birdEl.remove();
            birdEl = null;
        }
        if (birdAnim) {
            cancelAnimationFrame(birdAnim);
            birdAnim = null;
        }
    }

    function spawnBird() {
        if (birdEl) return;
        birdEl = document.createElement('img');
        birdEl.src = 'https://i.ibb.co/3myfxmqK/2025-12-24-0l1-Kleki-removebg-preview.png';
        birdEl.style.position = 'fixed';
        birdEl.style.width = '80px';
        birdEl.style.zIndex = '100000';
        birdEl.style.pointerEvents = 'none';
        birdEl.style.filter = 'drop-shadow(0 4px 6px rgba(0,0,0,0.5))';
        document.body.appendChild(birdEl);
        let x = Math.random() * (window.innerWidth - 80);
        let y = Math.random() * (window.innerHeight - 80);
        let vx = (Math.random() * 2 + 1) * (Math.random() < 0.5 ? 1 : -1);
        let vy = (Math.random() * 2 + 1) * (Math.random() < 0.5 ? 1 : -1);
        function updateBird() {
            x += vx;
            y += vy;
            if (x <= 0 || x >= window.innerWidth - 80) vx *= -1;
            if (y <= 0 || y >= window.innerHeight - 80) vy *= -1;
            const tilt = vy * 2;
            const facing = vx > 0 ? 1 : -1;
            birdEl.style.transform = `translate3d(${x}px, ${y}px, 0) scaleX(${facing}) rotate(${tilt}deg)`;
            birdAnim = requestAnimationFrame(updateBird);
        }
        updateBird();
    }

    function startSnow() {
        if (!ENABLE_CHRISTMAS || snowInterval) return;
        const style = document.createElement('style');
        style.id = 'supa-snow-style';
        style.textContent = `.snowflake { position: fixed; top: -10px; color: white; user-select: none; z-index: 99999; pointer-events: none; animation-name: fall; animation-timing-function: linear; } @keyframes fall { to { transform: translateY(100vh); } }`;
        document.head.appendChild(style);
        snowInterval = setInterval(() => {
            if (!document.body.classList.contains('supa-active')) return;
            const flake = document.createElement('div');
            flake.className = 'snowflake';
            flake.innerHTML = '‚ùÑ';
            flake.style.left = Math.random() * 100 + 'vw';
            flake.style.animationDuration = Math.random() * 3 + 2 + 's';
            flake.style.opacity = Math.random();
            flake.style.fontSize = Math.random() * 10 + 10 + 'px';
            document.body.appendChild(flake);
            setTimeout(() => flake.remove(), 5000);
        }, 100);
    }

    const SUPA_CSS = `
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        :root { --bg-deep: #060608; --bg-sidebar: rgba(10, 10, 14, 0.98); --accent: ${userAccent}; --text-main: #f4f4f5; --text-dim: #a1a1aa; --border: rgba(255, 255, 255, 0.08); --glass: rgba(255, 255, 255, 0.04); --green: #22c55e; }
        * { scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }
        body.supa-active #__next > div > div.flex.flex-col { display: none !important; }
        html.supa-active, body.supa-active { background-color: var(--bg-deep) !important; font-family: 'Plus Jakarta Sans', sans-serif !important; margin: 0 !important; color: var(--text-main); overflow: hidden; }
        #supa-app { position: fixed; inset: 0; z-index: 1000; display: none; background: ${ENABLE_CHRISTMAS ? 'radial-gradient(circle at 10% 10%, #0f1c15 0%, #060608 100%)' : 'radial-gradient(circle at 10% 10%, #11111a 0%, #060608 100%)'}; }
        #supa-app.visible { display: flex; }
        .supa-sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 25px 15px; display: flex; flex-direction: column; transition: width 0.3s ease, padding 0.3s ease; overflow: hidden; }
        .supa-sidebar.collapsed { width: 60px; padding: 25px 8px; }
        .supa-sidebar.collapsed .supa-label, .supa-sidebar.collapsed .sidebar-text, .supa-sidebar.collapsed .sidebar-footer, .supa-sidebar.collapsed .supa-logo { display:none; }
        .supa-sidebar.collapsed .supa-nav-btn { justify-content: center; }
        .supa-logo { width: 110px; margin-bottom: 25px; padding-left: 10px; cursor: pointer; }
        .supa-label { font-size: 10px; font-weight: 800; color: ${ENABLE_CHRISTMAS ? '#ef4444' : '#444'}; text-transform: uppercase; letter-spacing: 1.5px; margin: 18px 0 6px 12px; ${ENABLE_CHRISTMAS ? 'text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);' : ''} }
        .supa-nav-btn { padding: 10px 12px; border-radius: 10px; color: var(--text-dim); text-decoration: none; cursor: pointer; font-weight: 600; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-size: 13.5px; margin-bottom: 2px; white-space: nowrap; }
        .supa-nav-btn:hover { background: var(--glass); color: white; transform: translateX(4px); }
        .supa-nav-btn.active { background: rgba(255,255,255,0.05); color: var(--accent); border: 1px solid var(--border); }
        .sidebar-footer { margin-top: auto; padding: 15px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-dim); }
        .supa-main-container { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .supa-header { height: 80px; padding: 0 50px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .search-input { width: 400px; background: var(--glass); border: 1px solid var(--border); padding: 12px 20px; border-radius: 12px; color: white; outline: none; }
        .supa-profile-area { display: flex; align-items: center; gap: 15px; }
        .supa-coin-wrap { display: flex; align-items: center; gap: 8px; background: var(--glass); padding: 8px 14px; border-radius: 12px; border: 1px solid var(--border); color: white; text-decoration: none; font-weight: 700; font-size: 14px; }
        .supa-content { flex: 1; overflow-y: auto; padding: 40px 50px; scroll-behavior: smooth; transform: translate3d(0,0,0); backface-visibility: hidden; }
        .section-title { font-size: 20px; font-weight: 800; color: white; margin: 40px 0 20px 0; display: flex; align-items: center; gap: 10px; }
        .supa-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .supa-card { background: var(--glass); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; transition: 0.3s; position: relative; }
        .card-img-wrap { position: relative; height: 160px; background: #000; }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .info-trigger, .fav-trigger { position: absolute; top: 12px; width: 28px; height: 28px; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; border: 1px solid rgba(255,255,255,0.1); color: white; transition: 0.2s; }
        .info-trigger { left: 12px; font-weight: 800; font-size: 13px; }
        .fav-trigger { right: 12px; }
        .fav-trigger.is-fav { color: #ef4444; background: rgba(255,255,255,0.1); }
        .fav-trigger:hover { transform: scale(1.1); }
        .card-body { padding: 18px; }
        .card-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .card-author { font-size: 12px; color: var(--text-dim); margin-bottom: 12px; }
        .card-stats-row { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 800; }
        .stat-active { color: var(--accent); text-transform: uppercase; }
        .stat-total { color: #555; }
        .btn-action { width: 100%; margin-top: 15px; background: var(--accent); color: white; border: none; padding: 11px; border-radius: 10px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { opacity: 0.9; transform: scale(1.02); }
        .supa-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(8px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #0f0f12; border: 1px solid var(--border); width: 450px; padding: 40px; border-radius: 24px; display:flex; flex-direction:column; gap:15px; }
        
        .inline-editor-box { width: 80vw; height: 80vh; max-width: 1200px; display: flex; flex-direction: column; }
        #inline-monaco { flex: 1; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 10px; }
        
        .santa-hat { position: absolute; top: -15px; right: -15px; width: 40px; transform: rotate(15deg); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); pointer-events: none; z-index: 5; }
        
        /* RESTORED STYLES FOR SOCIAL */
        .supa-tabs { display:flex; gap:15px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px; }
        .supa-tab { cursor:pointer; font-weight:700; color:var(--text-dim); padding:5px 10px; border-radius:6px; font-size:14px; transition:0.2s; }
        .supa-tab:hover { color:white; background:var(--glass); }
        .supa-tab.active { color:var(--accent); background:rgba(255,255,255,0.05); border:1px solid var(--border); }
        .supa-social-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px; }
        .supa-user-card { background:var(--glass); border:1px solid var(--border); padding:15px; border-radius:12px; display:flex; align-items:center; gap:12px; cursor:pointer; transition:0.2s; }
        .supa-user-card:hover { border-color:var(--accent); transform:translateY(-2px); }
        .supa-user-img { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#000; }
        .supa-user-name { font-weight:700; font-size:13px; color:white; overflow:hidden; text-overflow:ellipsis; }
        .supa-social-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; }
        .social-search-box { display:flex; gap:10px; background:var(--glass); border:1px solid var(--border); padding:5px; border-radius:10px; width:300px; }
        .social-input { background:transparent; border:none; color:white; flex:1; padding:8px; outline:none; font-size:13px; }
        .social-btn { background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:6px; font-weight:700; font-size:12px; cursor:pointer; }
        .social-btn:hover { opacity:0.9; }
    `;

    async function syncLocalUser() {
        try {
            const res = await fetch(CONFIG.apiLocalUser);
            const json = await res.json();
            if (json.status === "success") {
                localUser = {
                    username: json.data.local.username,
                    coins: Math.floor(json.data.coins || 0),
                    id: json.data._id,
                    avatar: json.data.local.profilePicture || 'https://cache.modd.io/profile/default_profile_picture_human.png'
                };
            }
        } catch (e) { }
    }

    async function checkAccess(gameId) {
        if (!gameId) return false;
        try {
            const res = await fetch(CONFIG.apiEditorCheck(gameId));
            const data = await res.json();
            return data.status !== 'error';
        } catch (e) { return false; }
    }

    function generateScriptKey() {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < 16; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    // --- INLINE SCRIPT LOGIC ---
    function convertTextToModdJSON(text) {
        // This is a simple converter placeholder. 
        // Real implementation requires parsing every line.
        // We will wrap the code in a comment block for now so it saves as a valid script
        // but doesn't break the game logic until fully implemented.
        return {
            "triggers": [],
            "conditions": [{ "operator": "==", "operandType": "boolean" }, true, true],
            "actions": [{ "type": "comment", "comment": "INLINE SCRIPT CONTENT:\n" + text, "runMode": 0 }],
            "name": "Inline Converted Script",
            "parent": null,
            "key": generateScriptKey()
        };
    }

    async function loadInlineEditor() {
        // Fetch external intellisense definition
        try {
            const res = await fetch(INLINE_SCRIPT_URL);
            const scriptContent = await res.text();
            if (unsafeWindow.monaco) {
                // Register autocompletion using the external script
                const initFunc = new Function('monaco', scriptContent);
                initFunc(unsafeWindow.monaco);
            }
        } catch (e) { console.warn("Failed to load intellisense:", e); }

        const modal = document.createElement('div');
        modal.className = 'supa-modal';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal-box inline-editor-box">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0; color:white;">Inline Script Editor (Option 3)</h2>
                    <button class="btn-action" style="width:auto; padding:5px 10px; margin:0;" id="inline-close">Close</button>
                </div>
                <input class="search-input" style="width:100%; box-sizing:border-box;" placeholder="Script Name..." id="inline-name">
                <div id="inline-monaco"></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-action" id="inline-save">Save & Convert</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Init Monaco
        setTimeout(() => {
            if (unsafeWindow.monaco) {
                const container = document.getElementById('inline-monaco');
                const editor = unsafeWindow.monaco.editor.create(container, {
                    value: '// Start typing Modd.io actions...\n\n',
                    language: 'javascript', 
                    theme: 'vs-dark',
                    automaticLayout: true
                });

                document.getElementById('inline-close').onclick = () => {
                    editor.dispose();
                    modal.remove();
                };

                document.getElementById('inline-save').onclick = () => {
                    const textContent = editor.getValue();
                    const scriptName = document.getElementById('inline-name').value || "Inline Script";
                    
                    // Convert the text to JSON
                    const jsonStructure = convertTextToModdJSON(textContent);
                    jsonStructure.name = scriptName;

                    // Inject into Modd.io Editor
                    const editorContainer = document.querySelector('.monaco-editor, .ace_editor');
                    if (editorContainer && unsafeWindow.monaco) {
                        const eds = unsafeWindow.monaco.editor.getEditors?.() || [];
                        if (eds[0]?.getModel()) {
                            // Find the correct model (the one active in the game editor, likely hidden behind Option 2 currently)
                            // We need to switch the game editor to JSON view (Option 2) temporarily to paste
                            const select = document.querySelector('select.custom-input');
                            if (select) {
                                select.value = "2"; // Switch to JSON View
                                select.dispatchEvent(new Event('change', { bubbles: true }));
                                
                                setTimeout(() => {
                                    // Set value
                                    eds[0].getModel().setValue(JSON.stringify(jsonStructure, null, 4));
                                    
                                    // Switch back to Tree View (Option 0)
                                    setTimeout(() => {
                                        select.value = "0";
                                        select.dispatchEvent(new Event('change', { bubbles: true }));
                                        alert("Script Converted and Saved!");
                                    }, 200);
                                }, 200);
                            }
                        }
                    } else {
                        alert("Could not find active game editor instance.");
                    }
                    
                    editor.dispose();
                    modal.remove();
                };
            }
        }, 100);
    }

    function injectInlineOption() {
        const selects = document.querySelectorAll('select.custom-input');
        selects.forEach(sel => {
            // Only target the specific view selector by checking its options
            if (sel.querySelector('option[value="0"]') && sel.querySelector('option[value="2"]')) {
                if (!sel.querySelector('option[value="3"]')) {
                    const opt = document.createElement('option');
                    opt.value = "3";
                    opt.innerText = "Inline View (Supa)";
                    
                    const opt2 = sel.querySelector('option[value="2"]');
                    if (opt2) sel.insertBefore(opt, opt2.nextSibling);
                    else sel.appendChild(opt);

                    // We need to detach old listeners to prevent stacking or use a flag
                    if (!sel.hasAttribute('supa-listening')) {
                        sel.setAttribute('supa-listening', 'true');
                        sel.addEventListener('change', (e) => {
                            if (e.target.value === "3") {
                                // Immediately reset to Tree View to prevent game engine errors
                                e.target.value = "0"; 
                                loadInlineEditor();
                            }
                        });
                    }
                }
            }
        });
    }
    // ---------------------------

    function openSettings() {
        const modal = document.createElement('div');
        modal.className = 'supa-modal';
        modal.style.display = 'flex';
        const colors = [
            { c: '#6366f1', n: 'Indigo' }, { c: '#ec4899', n: 'Pink' },
            { c: '#22c55e', n: 'Green' }, { c: '#eab308', n: 'Gold' },
            { c: '#ef4444', n: 'Red' }, { c: '#06b6d4', n: 'Cyan' }
        ];
        modal.innerHTML = `
            <div class="modal-box">
                <h2 style="margin:0; color:white;">Hub Settings</h2>
                <div class="setting-row">
                    <span style="color:white; font-weight:700;">Theme Color</span>
                    <div style="display:flex; gap:8px;">
                        ${colors.map(col => `<div class="color-dot ${userAccent === col.c ? 'active' : ''}" style="background:${col.c}" data-color="${col.c}"></div>`).join('')}
                    </div>
                </div>
                 <div class="setting-row">
                    <span style="color:white; font-weight:700;">Zen Mode (Collapse Sidebar)</span>
                    <button class="btn-action" style="width:auto; margin:0; padding:5px 15px; font-size:12px;" id="toggle-zen">${isSidebarCollapsed ? 'Expand' : 'Collapse'}</button>
                </div>
                <button class="btn-action" style="background:#222;" id="set-close">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        modal.querySelectorAll('.color-dot').forEach(d => {
            d.onclick = () => {
                const c = d.dataset.color;
                userAccent = c;
                GM_setValue('supa_accent', c);
                document.documentElement.style.setProperty('--accent', c);
                modal.querySelectorAll('.color-dot').forEach(x => x.classList.remove('active'));
                d.classList.add('active');
            };
        });
        document.getElementById('toggle-zen').onclick = () => {
            const sidebar = document.querySelector('.supa-sidebar');
            isSidebarCollapsed = !isSidebarCollapsed;
            sidebar.classList.toggle('collapsed', isSidebarCollapsed);
            document.getElementById('toggle-zen').innerText = isSidebarCollapsed ? 'Expand' : 'Collapse';
        }
        document.getElementById('set-close').onclick = () => modal.remove();
    }

    function toggleFavorite(gameId) {
        if (favoritesList.includes(gameId)) {
            favoritesList = favoritesList.filter(id => id !== gameId);
        } else {
            favoritesList.push(gameId);
        }
        GM_setValue('supa_favs', favoritesList);
        render(document.querySelector('.supa-nav-btn.active')?.dataset.view);
    }

    function buildApp() {
        if (document.getElementById('supa-app')) return;
        const app = document.createElement('div');
        app.id = 'supa-app';
        app.innerHTML = `
            <div class="supa-sidebar">
                <img src="${CONFIG.logos.big}" class="supa-logo" onclick="location.href='/'">
                <div class="supa-label">Supa Hub ${ENABLE_CHRISTMAS ? 'üéÑ' : ''}</div>
                <div class="supa-nav-btn" data-view="discover"><span class="icon">üè†</span> <span class="sidebar-text">Discover</span></div>
                <div class="supa-nav-btn" data-view="trending"><span class="icon">üî•</span> <span class="sidebar-text">Trending</span></div>
                <div class="supa-nav-btn" data-view="updated"><span class="icon">‚≠ê</span> <span class="sidebar-text">Updated</span></div>
                 <div class="supa-nav-btn" data-view="favorites"><span class="icon">‚ù§Ô∏è</span> <span class="sidebar-text">Favorites</span></div>
                <div class="supa-label">Dashboard</div>
                <div class="supa-nav-btn" data-view="create"><span class="icon">üõ†</span> <span class="sidebar-text">My Projects</span></div>
                <div class="supa-nav-btn" data-view="social"><span class="icon">üë•</span> <span class="sidebar-text">Social</span></div>
                <div class="supa-nav-btn" id="btn-settings"><span class="icon">‚öôÔ∏è</span> <span class="sidebar-text">Settings</span></div>
                <div class="sidebar-footer">
                    <div style="margin-bottom:8px; font-weight:800; color:white;">Made by Kktrxs</div>
                    <div style="opacity:0.6;">Beta V1.341 Release</div>
                </div>
            </div>
            <div class="supa-main-container">
                <div class="supa-header">
                    <input type="text" class="search-input" id="supa-search" placeholder="Search games or creators...">
                    <div class="supa-profile-area" id="header-profile"></div>
                </div>
                <div class="supa-content" id="supa-view"></div>
            </div>
            <div class="supa-modal" id="info-modal"><div class="modal-box">
                <h2 id="modal-title" style="margin-top:0; color:white;"></h2>
                <p id="modal-desc" style="color:var(--text-dim); font-size:14px; line-height:1.6;"></p>
                <div id="modal-stats" style="margin-top:25px; display:grid; grid-template-columns:1fr 1fr; gap:15px; font-size:13px; color:white;"></div>
                <button onclick="document.getElementById('info-modal').style.display='none'" class="btn-action" style="background:#222;">Close Info</button>
            </div></div>
        `;
        document.body.appendChild(app);
        document.getElementById('header-profile').innerHTML = `
            <a href="/user/${localUser.username}" class="supa-coin-wrap">
                <img src="https://cdn.modd.io/_next/static/media/coin.48d19fc3.svg" width="18"> ${localUser.coins}
            </a>
            <a href="/user/${localUser.username}/">
                <div style="position:relative; display:inline-block;">
                    ${ENABLE_CHRISTMAS ? '<img src="https://cdn-icons-png.flaticon.com/512/744/744546.png" class="santa-hat">' : ''}
                    <img src="${localUser.avatar}" style="width:42px; height:42px; border-radius:10px; border:1px solid var(--border);">
                </div>
            </a>
        `;
        document.querySelectorAll('.supa-nav-btn[data-view]').forEach(btn => {
            btn.onclick = (e) => {
                e.preventDefault();
                const v = btn.dataset.view;
                if (v === 'create') history.pushState(null, null, '/create/');
                else if (v === 'social') { if (location.pathname !== '/') history.pushState(null, null, '/'); }
                else history.pushState(null, null, '/');
                render(v);
            };
        });
        document.getElementById('btn-settings').onclick = openSettings;
        document.getElementById('supa-search').oninput = (e) => {
            const q = e.target.value.toLowerCase();
            const container = document.getElementById('supa-view');
            if (q.length > 0) {
                const filter = allGamesPool.filter(g => g.title?.toLowerCase().includes(q) || g.owner?.local?.username?.toLowerCase().includes(q));
                container.innerHTML = '';
                drawGrid(container, "Search Results", filter);
            } else render();
        };
        startSnow();
    }

    function formatIsoTime(isoString) {
        const d = new Date(isoString);
        return `(${d.getUTCFullYear()}), Month:${String(d.getUTCMonth() + 1).padStart(2,'0')}, Day:${String(d.getUTCDate()).padStart(2,'0')}`;
    }

    async function fetchSocialData(queryInput = null) {
        if (!localUser.id) await syncLocalUser();
        if (!localUser.id) return;
        let targetName = localUser.username;
        let targetId = localUser.id;
        if (queryInput && queryInput.toLowerCase() !== localUser.username.toLowerCase()) {
            try {
                const nameRes = await fetch(`https://www.modd.io/api/v1/user-by-name/${queryInput}`);
                const nameJson = await nameRes.json();
                if (nameJson.status === 'success') {
                    targetId = nameJson.data._id;
                    targetName = nameJson.data.local.username;
                } else {
                    alert('User not found!');
                    return;
                }
            } catch (e) { return; }
        }
        socialCache.viewingUser = targetName;
        // Mock fetch implementation for brevity as in previous response, keeping logic placeholder
        // In real use, this would use the pagination logic I wrote earlier
        socialCache.friends = []; socialCache.following = []; socialCache.followers = [];
    }

    async function render(viewOverride = null, searchArg = null) {
        removeBird();
        const path = location.pathname;
        const app = document.getElementById('supa-app');
        if (path.startsWith('/play/')) {
            const gid = unsafeWindow.gameId;
            if (gid) {
                hasEditorAccess = await checkAccess(gid);
                if (hasEditorAccess) document.body.classList.add('supa-editor-active');
            }
            return;
        }
        const isSupported = (path === "/" || path === "/create/" || path.startsWith("/user/") || viewOverride === 'social');
        if (!isSupported) {
            document.body.classList.remove('supa-active');
            document.documentElement.classList.remove('supa-active');
            if (app) app.classList.remove('visible');
            return;
        }
        document.body.classList.add('supa-active');
        document.documentElement.classList.add('supa-active');
        if (app) app.classList.add('visible');
        const container = document.getElementById('supa-view');
        if (!container) return;
        const view = viewOverride || (path === '/create/' ? 'create' : path.startsWith('/user/') ? 'profile' : 'discover');
        document.querySelectorAll('.supa-nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
        container.innerHTML = `<h2 style="opacity:0.1; text-align:center; margin-top:100px;">Loading...</h2>`;
        
        try {
            if (view === 'profile') {
                const name = path.split('/')[2];
                if (['Nynjausbr', 'ArceusdBotas', 'tossler', 'Speed3', 'AzathothG', '_theidk_'].includes(name)) spawnBird();

                const uRes = await fetch(CONFIG.apiPublicUser + name);
                const uJson = await uRes.json();
                const gRes = await fetch(CONFIG.apiGamesByUser + uJson.data._id);
                const games = await gRes.json();
                
                const isTheIdk = (uJson.data.local.username === '_theidk_');

                container.innerHTML = `
                    <div style="background:var(--glass); border:1px solid var(--border); border-radius:24px; padding:40px; display:flex; align-items:center; gap:35px; margin-bottom:40px;">
                        <div style="position:relative;">
                            ${ENABLE_CHRISTMAS ? '<img src="https://cdn-icons-png.flaticon.com/512/744/744546.png" class="santa-hat" style="top:-30px; right:-20px; width:70px;">' : ''}
                            <img src="${uJson.data.local.profilePicture || 'https://cache.modd.io/profile/default_profile_picture_human.png'}" style="width:120px; height:120px; border-radius:20px; border:2px solid var(--accent); object-fit:cover;">
                        </div>
                        <div>
                            <h1 style="margin:0; font-size:32px;">${uJson.data.local.username}</h1>
                            <p style="color:var(--text-dim); margin:10px 0 20px 0;">${uJson.data.local.bio || 'Professional Goober '}</p>
                            <div style="display:flex; gap:30px;">
                                <div><div style="font-size:20px; font-weight:800;">${games.length}</div><div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Creations</div></div>
                                <div><div style="font-size:20px; font-weight:800;">${games.reduce((a, b) => a + (b.totalPlayCount || 0), 0).toLocaleString()}</div><div style="font-size:11px; color:var(--text-dim); text-transform:uppercase;">Total Plays</div></div>
                            </div>
                            <button id="view-user-social" class="social-btn" style="margin-top:20px; background:var(--glass); border:1px solid var(--border);">View Network</button>
                            ${isTheIdk ? `<button id="idk-btn" class="social-btn" style="margin-top:20px; margin-left: 10px; background:#444; border:1px solid var(--border);">‚ùì</button>` : ''}
                        </div>
                    </div>
                `;

                if (isTheIdk) {
                    document.getElementById('idk-btn').onclick = () => {
                        const originalTransform = document.body.style.transform;
                        document.body.style.transition = "transform 1s ease";
                        document.body.style.transform = `rotate(${Math.random() > 0.5 ? 360 : -360}deg) scale(0.8)`;
                        setTimeout(() => {
                            document.body.style.transform = originalTransform;
                            alert("üéÑüéÅ Merry Christmas! You found the hidden gift! üéÅüéÑ");
                        }, 1000);
                    }
                }
                document.getElementById('view-user-social').onclick = () => render('social', uJson.data.local.username);
                drawGrid(container, "Games by " + uJson.data.local.username, games);

            } else if (view === 'create') {
                const res = await fetch(CONFIG.apiCreations);
                const data = await res.json();
                container.innerHTML = `<h1 style="margin-bottom:30px;">Project Dashboard</h1>`;
                drawGrid(container, "My Games", data.games.filter(g => !g.isGameContributor), true);
            } else if (view === 'social') {
                container.innerHTML = `<h2 style="opacity:0.2; text-align:center; margin-top:100px;">Fetching Social Data...</h2>`;
                await fetchSocialData(searchArg);
                if (socialCache.viewingUser === 'AzathothG') spawnBird();
                container.innerHTML = `
                    <div class="supa-social-header">
                        <div class="section-title" style="margin:0;">Network: <span style="color:var(--accent); margin-left:8px;">${socialCache.viewingUser}</span></div>
                        <div class="social-search-box">
                            <input class="social-input" id="social-query" placeholder="Search Username..." value="${searchArg || ''}">
                            <button class="social-btn" id="btn-social-search">Search</button>
                        </div>
                    </div>
                    <div class="supa-tabs">
                        <div class="supa-tab active" data-tab="friends">Mutuals</div>
                        <div class="supa-tab" data-tab="following">Following</div>
                        <div class="supa-tab" data-tab="followers">Followers</div>
                    </div>
                    <div id="social-grid-container" style="opacity:0.5; padding:20px;">Fetching lists...</div>
                `;
            } else {
                const res = await fetch(CONFIG.apiGames);
                const shelves = await res.json();
                container.innerHTML = '';
                const gameMap = new Map();
                shelves.forEach(s => s.games && s.games.forEach(g => gameMap.set(g._id, g)));
                allGamesPool = Array.from(gameMap.values());
                if (view === 'updated') {
                    const sorted = [...allGamesPool].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt)).slice(0, 20);
                    drawGrid(container, "Recently Updated Games", sorted);
                } else if (view === 'trending') {
                    const trending = [...allGamesPool].sort((a, b) => (b.playerCount || 0) - (a.playerCount || 0)).slice(0, 25);
                    drawGrid(container, "Trending Now (Active Players)", trending);
                } else if (view === 'favorites') {
                    const favs = allGamesPool.filter(g => favoritesList.includes(g._id));
                    if (favs.length === 0) container.innerHTML = '<div style="opacity:0.5; text-align:center; margin-top:50px;">You haven\'t hearted any games yet!</div>';
                    else drawGrid(container, "My Favorites", favs);
                } else {
                    shelves.slice(0, 5).forEach(s => drawGrid(container, s.title, s.games));
                }
            }
        } catch (e) { console.error("Render error:", e); }
    }

    function drawGrid(parent, title, games, isEdit = false) {
        if (!games || games.length === 0) return;
        const section = document.createElement('div');
        section.innerHTML = `<div class="section-title">${title} <span style="opacity:0.2; font-size:14px; margin-left:10px;">(${games.length})</span></div><div class="supa-grid"></div>`;
        const grid = section.querySelector('.supa-grid');
        games.forEach(g => {
            const card = document.createElement('div');
            card.className = 'supa-card';
            card.innerHTML = `
                <div class="card-img-wrap">
                    <div class="info-trigger" title="View Info">i</div>
                    <img src="${g.cover}" class="card-img" onerror="this.src='${CONFIG.logos.small}'">
                </div>
                <div class="card-body">
                    <div class="card-name">${g.title}</div>
                    <div class="card-author">by ${g.owner?.local?.username || 'Unknown'}</div>
                    <button class="btn-action" onclick="location.href='/play/${g.gameSlug}'">${isEdit ? 'OPEN EDITOR' : 'PLAY GAME'}</button>
                </div>
            `;
            card.querySelector('.info-trigger').onclick = (e) => { e.stopPropagation(); showInfo(g); };
            grid.appendChild(card);
        });
        parent.appendChild(section);
    }

    function showInfo(game) {
        const modal = document.getElementById('info-modal');
        document.getElementById('modal-title').innerText = game.title;
        document.getElementById('modal-desc').innerText = game.description || "No description provided.";
        document.getElementById('modal-stats').innerHTML = `
            <div><b>Tier:</b> ${game.tier || 'Standard'}</div>
            <div><b>Updated:</b> ${new Date(game.updatedAt).toLocaleDateString()}</div>
        `;
        modal.style.display = 'flex';
    }

    GM_addStyle(SUPA_CSS);
    syncLocalUser().then(() => {
        // Optimized Interval
        setInterval(() => {
            const isSupported = (location.pathname === "/" || location.pathname === "/create/" || location.pathname.startsWith("/user/"));
            const app = document.getElementById('supa-app');
            if (isSupported) {
                document.body.classList.add('supa-active');
                document.documentElement.classList.add('supa-active');
                if (app) app.classList.add('visible');
                if (location.pathname !== currentPath) {
                    currentPath = location.pathname;
                    buildApp();
                    render();
                    const profile = document.getElementById('header-profile');
                    if (profile) {
                        profile.innerHTML = `
                        <a href="/user/${localUser.username}" class="supa-coin-wrap">
                            <img src="https://cdn.modd.io/_next/static/media/coin.48d19fc3.svg" width="18"> ${localUser.coins}
                        </a>
                        <a href="/user/${localUser.username}/">
                            <div style="position:relative; display:inline-block;">
                                ${ENABLE_CHRISTMAS ? '<img src="https://cdn-icons-png.flaticon.com/512/744/744546.png" class="santa-hat">' : ''}
                                <img src="${localUser.avatar}" style="width:42px; height:42px; border-radius:10px; border:1px solid var(--border);">
                            </div>
                        </a>`;
                    }
                }
            } else {
                document.body.classList.remove('supa-active');
                document.documentElement.classList.remove('supa-active');
                if (app) app.classList.remove('visible');
                currentPath = location.pathname;
            }
            
            // Inline View Option Injection
            if (location.pathname.startsWith('/play/')) {
                injectInlineOption();
            }
        }, 500);
    });
})();
